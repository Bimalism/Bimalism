<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chain Reaction</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Arial;
  background:radial-gradient(circle at top,#1b1b1b,#000);
  color:#eee;
  height:100vh;
  overflow:hidden;
}

/* SETTINGS BUTTON */
#settingsBtn{
  position:fixed;
  top:12px;
  left:12px;
  z-index:10;
  padding:10px 14px;
  border:none;
  border-radius:12px;
  background:#333;
  color:#fff;
  font-size:18px;
}

/* PHONE STYLE SETTINGS */
#settingsOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:flex-end;
  z-index:20;
}

.settingsBox{
  width:100%;
  max-height:85%;
  background:#121212;
  border-radius:18px 18px 0 0;
  padding:16px;
  overflow-y:auto;
  animation:slideUp .25s ease;
}

@keyframes slideUp{
  from{transform:translateY(100%)}
  to{transform:translateY(0)}
}

.settingsBox h2{
  text-align:center;
  margin:6px 0 12px;
}

.settingRow{
  background:#1e1e1e;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.settingRow input{
  width:70px;
  padding:6px;
  border-radius:8px;
  border:none;
}

.settingBtn{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  margin-top:8px;
  background:#2a2a2a;
  color:#fff;
  font-size:15px;
}

.settingBtn.primary{background:#444}

/* GRID */
.grid-wrap{
  height:100%;
  display:flex;
  justify-content:center;
  align-items:center;
}

.grid{
  display:grid;
  gap:6px;
  padding:10px;
}

.cell{
  width:48px;
  height:48px;
  background:#222;
  border-radius:12px;
  position:relative;
  touch-action:manipulation;
}

.orb{
  width:14px;
  height:14px;
  border-radius:50%;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  box-shadow:0 0 6px rgba(255,255,255,.5);
}

#turnInfo{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  padding:8px 14px;
  border-radius:12px;
  font-weight:bold;
}

/* MOBILE */
@media(max-width:600px){
  .cell{width:38px;height:38px}
}
</style>
</head>

<body>

<button id="settingsBtn">⚙</button>

<div id="settingsOverlay">
  <div class="settingsBox">
    <h2>Game Settings</h2>

    <div class="settingRow">Rows <input id="rows" type="number" value="6" min="5" max="12"></div>
    <div class="settingRow">Cols <input id="cols" type="number" value="9" min="5" max="12"></div>
    <div class="settingRow">Players <input id="playerCount" type="number" value="4" min="2" max="10"></div>

    <button class="settingBtn" id="playerMode">Player Mode</button>
    <button class="settingBtn" id="aiMode">AI Mode</button>
    <button class="settingBtn primary" id="newGame">Start Game</button>
    <button class="settingBtn" onclick="closeSettings()">Close</button>
  </div>
</div>

<div class="grid-wrap">
  <div class="grid" id="grid"></div>
</div>

<div id="turnInfo">Turn: —</div>

<script>
const COLORS=['#ff3b3b','#3b6cff','#3bff6f','#ffe93b','#b93bff',
'#ff8ad8','#3bfff3','#ff963b','#8aff3b','#ffffff'];

let ROWS=6,COLS=9;
let players=[],grid=[],current=0,aiMode=false;

const gridEl=document.getElementById('grid');

const idx=(c,r)=>r*COLS+c;
const cap=(c,r)=>{
  const edge=c==0||r==0||c==COLS-1||r==ROWS-1;
  const corner=(c==0||c==COLS-1)&&(r==0||r==ROWS-1);
  return corner?2:edge?3:4;
};

function setupPlayers(n){
  players=[];
  for(let i=0;i<n;i++)
    players.push({id:i,color:COLORS[i],ai:aiMode});
}

function setupGrid(){
  gridEl.innerHTML='';
  gridEl.style.gridTemplateColumns=`repeat(${COLS},1fr)`;
  grid=Array(ROWS*COLS).fill().map(()=>({o:-1,c:0}));

  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const d=document.createElement('div');
    d.className='cell';
    d.onclick=()=>!players[current].ai&&move(c,r);
    gridEl.appendChild(d);
  }
  render();
}

function render(){
  [...gridEl.children].forEach((cell,i)=>{
    cell.innerHTML='';
    const g=grid[i];
    for(let k=0;k<g.c;k++){
      const o=document.createElement('div');
      o.className='orb';
      o.style.background=players[g.o]?.color||'#aaa';
      o.style.transform=`translate(${Math.cos(k)*8}px,${Math.sin(k)*8}px)`;
      cell.appendChild(o);
    }
  });
  turnInfo.textContent=`Turn: Player ${current+1}${players[current].ai?' (AI)':''}`;
}

function move(c,r){
  const cell=grid[idx(c,r)];
  if(cell.o!=-1&&cell.o!=current)return;
  explode(c,r,current);
  next();
}

function explode(c,r,p){
  const q=[[c,r]];
  grid[idx(c,r)].c++;
  grid[idx(c,r)].o=p;

  while(q.length){
    const [x,y]=q.shift();
    const cell=grid[idx(x,y)];
    if(cell.c>=cap(x,y)){
      cell.c-=cap(x,y);
      if(cell.c<=0)cell.o=-1;
      [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy])=>{
        const nx=x+dx,ny=y+dy;
        if(nx>=0&&ny>=0&&nx<COLS&&ny<ROWS){
          const n=grid[idx(nx,ny)];
          n.c++;n.o=p;
          if(n.c>=cap(nx,ny))q.push([nx,ny]);
        }
      });
    }
  }
  render();
}

function next(){
  current=(current+1)%players.length;
  render();
  if(players[current].ai)setTimeout(()=>aiMove(),500);
}

function aiMove(){
  const opts=[];
  grid.forEach((g,i)=>{
    if(g.o==-1||g.o==current)
      opts.push([i%COLS,Math.floor(i/COLS)]);
  });
  if(opts.length){
    const [c,r]=opts[Math.random()*opts.length|0];
    move(c,r);
  }
}

function openSettings(){settingsOverlay.style.display='flex'}
function closeSettings(){settingsOverlay.style.display='none'}

settingsBtn.onclick=openSettings;

playerMode.onclick=()=>aiMode=false;
aiMode.onclick=()=>aiMode=true;

newGame.onclick=()=>{
  ROWS=+rows.value; COLS=+cols.value;
  setupPlayers(+playerCount.value);
  setupGrid(); current=0;
  closeSettings();
};

setupPlayers(4);
setupGrid();
</script>
</body>
</html>
